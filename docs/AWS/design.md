# 電子パーツ管理アプリ AWS サーバーレス設計書 (詳細版)

本ドキュメントは、本アプリケーションをAWSサーバーレス環境で運用する際の、各コンポーネントの詳細な設計方針や設定値の意図、および将来のメンテナンスに向けたリファレンスをまとめたものです。

---

## 1. 全体アーキテクチャ概要

本システムは、完全マネージドなサーバーレス・アーキテクチャを採用しています。これにより、サーバーのOSパッチ当てなどの運用保守の手間を削減し、トラフィック増加に対する自動スケーリングと、アイドル時のコスト最小化（ほぼ無料）を実現しています。

*   **フロントエンド (SPA)**
    *   **Vite + Vue.js** で構築された静的ファイルを **S3** に配置し、**CloudFront** (CDN) 経由で配信します。
*   **バックエンド (API)**
    *   **Node.js (Express)** で実装されたAPIサーバーを **AWS Lambda** で実行します。
    *   HTTPリクエストとLambdaイベントの変換には、AWS公式の **AWS Lambda Web Adapter** レイヤーを利用し、ソースコードの修正なしに透過的な実行を実現しています。
    *   フロントエンドからのリクエストは **CloudFront → API Gateway HTTP API → Lambda** の経路で届きます。
*   **データベース / ストレージ**
    *   **SQLite** データファイルおよびアップロード画像群は、Lambdaにマウントされた **Amazon EFS** (Elastic File System) 上に保存され、状態を永続化しています。

---

## 2. インフラ・ネットワーク設計

### 2.1. VPC (Virtual Private Cloud)
Lambda関数とEFSを安全に連携させるため、システムはVPC内部に構築されます。
*   推奨構成: 最低2つのアベイラビリティゾーン (AZ) にプライベートサブネットを配置します。
*   ルーティング: EFSとの通信はVPC内部で完結するため、NAT Gatewayなどの外部通信要素は必須ではありません（コスト削減のため配置しないことを推奨）。

### 2.2. セキュリティグループ (SG)
*   **Lambda用 SG**: すべてのアウトバウンド通信(0.0.0.0/0)を許可（AWS API呼び出し等で必要になる場合があるため）。インバウンド通信の許可は不要です。
*   **EFS用 SG**: Lambda用SGからの **NFS (ポート 2049) のインバウンド通信のみ** を許可します。これにより、EFSへのアクセスを特定のLambdaからのみに厳密に制限しています。

---

## 3. コンポーネント別 詳細設計

### 3.1. CloudFront (配信・ルーティング層)

CloudFront はフロントエンドとバックエンドへの **統合エントリポイント** として機能します。

| パスパターン | 転送先 | 用途 |
|---|---|---|
| `/api/*` | API Gateway HTTP API | バックエンドAPIリクエスト |
| `/*`（デフォルト） | S3 | 静的ファイル配信 |

*   **S3バケットポリシー**: パブリックアクセスは全てブロックし、CloudFrontの Origin Access Control (OAC) を通じた読み取り(`s3:GetObject`)のみを許可します。
*   **カスタムエラードキュメント**: S3へのアクセス時に 403/404 が返った場合、Vue.jsのクライアントサイドルーティングを成立させるため、強制的に `index.html` (HTTP 200) を返すように設定します。
*   **フロントエンドの `VITE_API_BASE_URL`**: `https://<CloudFrontドメイン>/api` を指定します。これによりAPIリクエストも常にCloudFront経由になります。

### 3.2. IAM 認証と CloudFront Functions (セキュリティ・アクセス保護)
*   パブリックアクセスを防ぐための **Basic認証** を採用しています。
*   **CloudFront KeyValueStore**: パスワード情報（ユーザー名とSHA-256ハッシュのペア）をグローバルで高速に読み取れるKVSに保存します。
*   **CloudFront Functions (Viewer Request)**: リクエストヘッダの `Authorization` を抽出し、KVS内のハッシュ値と照合。不一致時は 401 Unauthorized を返却し、バックエンドやS3への到達前に不正アクセスを遮断します。

### 3.3. API Gateway HTTP API (APIルーティング層)

*   **プロトコル**: HTTP API（REST APIより低コスト・低レイテンシー）
*   **統合方式**: Lambda プロキシ統合（`$default` ルートで全リクエストをLambdaに転送）
*   **CORS設定**: API Gateway 側で `AllowOrigins: *` を設定。
*   **採用理由**: AWS Organizations の SCP（サービスコントロールポリシー）が Lambda Function URL への直接 HTTP アクセスをブロックするため、API Gateway を経由する構成に切り替えました。

### 3.4. AWS Lambda (バックエンド計算処理層)
*   **デプロイ形式**: .zipファイルアップロード方式。依存モジュール(`node_modules`)を含めた全コードをパッケージ化します。
*   **AWS Lambda Web Adapter**: `arn:aws:lambda:<region>:753240598075:layer:LambdaAdapterLayerArm64:<version>` のLayerを追加することで、ポート8080等でリッスンするExpressアプリにHTTPリクエストをルーティングします。
    *   *必須環境変数*: `AWS_LAMBDA_EXEC_WRAPPER=/opt/bootstrap`
    *   *ポート指定*: `PORT=8080` （Express側で受け取るポート）
*   **タイムアウト**: Express側でのファイル処理やSQLiteのスキャンがある程度発生することを想定し、デフォルトの3秒から **30秒〜1分程度** に引き上げておくことを推奨します。
*   **トリガー**: Lambda Function URL は使用しません。API Gateway HTTP API からのみ呼び出されます。

### 3.5. Amazon EFS (データベース・ストレージ層)
*   **マウント**: Lambda設定画面より、EFSアクセスポイントを `/mnt/efs` にマウントします。
*   **環境変数によるパス注入**: Expressアプリケーションは、以下の環境変数を読み込んでファイルの入出力先を決定します。
    *   `DB_PATH=/mnt/efs/database.sqlite`
    *   `UPLOAD_DIR=/mnt/efs/uploads`
*   **性能設計 (スループット)**: デフォルトの「バーストスループットモード」または「エラスティックスループット」を利用。個人〜小規模運用であれば、I/O性能がボトルネックになる懸念はほぼありません。

---

## 4. 運用・保守・トラブルシューティング

### 4.1. ログの確認 (CloudWatch Logs)
*   Express側で出力される `console.log` や `console.error` などは、すべて自動的に **CloudWatch Logs** の `/aws/lambda/<関数名>` ロググループに集約されます。
*   APIエラーやDBエラーが発生した場合は、まずこのログを確認してください。

### 4.2. ソースコードの更新とデプロイ
*   **フロントエンドの更新**: 手元の開発環境で `npm run build` を実行し、生成された `client/dist/` 以下の全ファイルを対象のS3バケットに上書きアップロードします。（必要に応じてCloudFrontのInvalidation(キャッシュ削除)を実行）
*   **バックエンドの更新**: `server` フォルダ以下を ZIP 化（`npm ci --omit=dev` 後）し、Lambdaのコンソール画面またはAWS CLIを用いて関数コードを更新（アップロード）します。

### 4.3. データベースのバックアップとリストア
*   アプリーケーション本体の「バックアップ（ZIPダウンロード）」および「リストア（ZIPアップロード）」機能は、**AWS環境上のEFSに対してもローカル運用時と全く同じように動作します。** 定期的にブラウザからバックアップ機能を利用してZIPをダウンロードし、手元に保管しておく運用を推奨します。

### 4.4. EFS内のファイル直接操作
*   万が一EFS上のSQLiteフィアルが破損した場合などで直接アクセスが必要な場合、VPC内に踏み台(Bastion)となる軽量なEC2（Amazon Linux等）を一時的に立ち上げ、そこからNFSマウントして操作する必要があります。（Cloud9を利用する方法も有効です）

---

## 5. 考慮事項とその解決策 (TBD/今後の課題)

1.  **SQLiteの同時書き込み制限（ロック）**
    *   **事象**: Lambdaはリクエスト増加に伴い複数のコンテナ（インスタンス）をスピンアップします。同時に複数のLambdaインスタンスからEFS上のSQLiteに対して**書き込み処理 (INSERT/UPDATE/DELETE)** が発生した場合、SQLite特有のファイルロックエラー (`database is locked`) が発生する可能性があります。
    *   **対策現状**: パーソナルユースや社内の少数メンバーでの利用であれば、完全な同時書き込みが発生する確率は極めて低く、実害はありません。
    *   **将来の発展**: 将来的に不特定多数が激しく書き込むアプリに成長した場合は、DBのみを Amazon Aurora Serverless (PostgreSQL / MySQL) 等へ移行し、ORM（現在のSQL直書き）の改修を行う必要があります。
